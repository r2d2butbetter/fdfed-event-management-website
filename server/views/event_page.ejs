<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/event_page.css">
    <link rel="stylesheet" href="/css/related_events.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>NIGHTLIFE - <%= event.title %>
    </title>
</head>

<body class="background-container">

    <%- include('partials/navbar') %>

        <div class="event-page-container">
            <!-- Gradient blobs for background design -->
            <div class="gradient-blob blob-1"></div>
            <div class="gradient-blob blob-2"></div>
            <div class="gradient-blob blob-3"></div>

            <div class="event-container">
                <div class="event-header">
                    <div class="event-image-container">
                        <div class="event-image">
                            <img src="<%= event.image ? (event.image.includes('/uploads/') ? event.image.replace('/uploads/', '/') : event.image) : '/images/blank.png' %>"
                                alt="<%= event.title %>">
                        </div>
                        <div class="event-buttons">
                            <% if (event.status==='start_selling' ) { %>
                                <a href="/payments/<%= event._id %>" class="register-btn">
                                    <i class="fas fa-ticket-alt"></i> Register Now
                                </a>
                                <% } else { %>
                                    <button class="register-btn disabled" disabled>
                                        <i class="fas fa-ticket-alt"></i> Registration Unavailable
                                    </button>
                                    <% } %>


                                        <!-- <button class="share-btn" onclick="shareEvent()">
                        <i class="fas fa-share-alt"></i> Share
                    </button> -->

                                        <form id="save-event-form" style="display: inline;">
                                            <input type="hidden" name="eventId" value="<%= event._id %>">
                                            <button type="submit" class="save-btn" id="save-event-btn">
                                                <i class="fas fa-bookmark"></i> <span id="save-btn-text">Save</span>
                                            </button>
                                        </form>

                        </div>
                    </div>
                    <div class="event-info">
                        <div>
                            <h1>
                                <%= event.title %>
                            </h1>
                            <span class="event-category">
                                <%= event.category %>
                            </span>

                            <div class="event-detail">
                                <i class="fas fa-calendar"></i>
                                <div class="event-detail-text">
                                    <strong>Start:</strong>
                                    <%= new Date(event.startDateTime).toLocaleString() %><br>
                                        <strong>End:</strong>
                                        <%= new Date(event.endDateTime).toLocaleString() %>
                                </div>
                            </div>

                            <div class="event-detail">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="event-detail-text">
                                    <%= event.venue %>
                                </div>
                            </div>

                            <div class="event-detail">
                                <i class="fas fa-ticket-alt"></i>
                                <div class="event-detail-text"><strong>Price:</strong> $<%= event.ticketPrice.toFixed(2)
                                        %>
                                </div>
                            </div>

                            <div class="event-detail">
                                <i class="fas fa-users"></i>
                                <div class="event-detail-text"><strong>Capacity:</strong>
                                    <%= event.capacity %> people
                                </div>
                            </div>

                            <div class="event-detail">
                                <i class="fas fa-info-circle"></i>
                                <div class="event-detail-text"><strong>Status:</strong>
                                    <%= event.status==='start_selling' ? 'Available' : 'Not Available' %>
                                </div>
                            </div>
                            <% if (event.organizerId) { %>
                                <div class="event-detail">
                                    <i class="fas fa-user-tie"></i>
                                    <div class="event-detail-text"><strong>Organized by:</strong>
                                        <%= event.organizerId.organizationName || 'Unknown' %>
                                    </div>
                                </div>
                                <% } %>
                        </div>
                    </div>
                </div>

                <div class="event-content">
                    <div class="event-section event-description">
                        <h2>About This Event</h2>
                        <p>
                            <%= event.description %>
                        </p>
                    </div>

                    <% if (typeof relatedEvents !=='undefined' && relatedEvents.length> 0) { %>
                        <div class="event-section related-events-section">
                            <h2>Related Events</h2>
                            <div class="cards-container">
                                <% relatedEvents.forEach(relEvent=> { %>
                                    <div class="category-card"
                                        onclick="window.location.href = '/event/<%= relEvent._id %>'">
                                        <img src="<%= relEvent.image ? (relEvent.image.includes('/uploads/') ? relEvent.image.replace('/uploads/', '/') : relEvent.image) : '/images/blank.png' %>"
                                            alt="<%= relEvent.title %>" />
                                        <p>
                                            <%= relEvent.title %>
                                        </p>
                                    </div>
                                    <% }); %>
                            </div>
                        </div>
                        <% } %>
                </div>
            </div>
        </div>

        <style>
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease-in-out;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .notification.show {
                opacity: 1;
                transform: translateX(0);
            }

            .notification.success {
                background-color: #10b981;
            }

            .notification.error {
                background-color: #ef4444;
            }

            .notification.info {
                background-color: #3b82f6;
            }

            .save-btn.saving {
                opacity: 0.7;
                pointer-events: none;
            }

            .save-btn.saved {
                background: #10b981 !important;
            }
        </style>

        <script>
            function showNotification(message, type = 'info') {
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notif => notif.remove());

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 4000);
            }

            document.addEventListener('DOMContentLoaded', function () {
                const saveForm = document.getElementById('save-event-form');
                const saveBtn = document.getElementById('save-event-btn');
                const saveBtnText = document.getElementById('save-btn-text');
                const eventId = saveForm.querySelector('input[name="eventId"]').value;

                let isSaved = false;

                // check if user is saved already
                fetch(`/user/check-saved-status?eventId=${eventId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.isSaved) {
                            isSaved = true;
                            saveBtn.classList.add('saved');
                            saveBtnText.textContent = 'Saved';
                        }
                    })
                    .catch(error => {
                        console.error('Error checking saved status:', error);
                    });

                if (saveForm) {
                    saveForm.addEventListener('submit', function (e) {
                        e.preventDefault();

                        saveBtn.classList.add('saving');
                        const originalText = saveBtnText.textContent;
                        saveBtnText.textContent = isSaved ? 'Unsaving...' : 'Saving...';

                        const endpoint = isSaved ? '/user/unsave-event' : '/user/save-event';
                        fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ eventId })
                        })
                            .then(response => response.json())
                            .then(data => {
                                saveBtn.classList.remove('saving');
                                if (data.success) {
                                    if (isSaved) {
                                        isSaved = false;
                                        saveBtn.classList.remove('saved');
                                        saveBtnText.textContent = 'Save';
                                        showNotification('Event unsaved successfully!', 'success');
                                    } else {

                                        isSaved = true;
                                        saveBtn.classList.add('saved');
                                        saveBtnText.textContent = 'Saved';
                                        showNotification(data.message, 'success');
                                    }
                                } else {
                                    saveBtnText.textContent = originalText;
                                    showNotification(data.message || 'An error occurred', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                saveBtn.classList.remove('saving');
                                saveBtnText.textContent = originalText;
                                showNotification('An error occurred', 'error');
                            });
                    });
                }
            });
        </script>
        <%- include('partials/footer') %>
</body>

</html>